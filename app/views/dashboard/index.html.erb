<!-- Barra azul -->
<div style="background-color: #2e5d70; height: 40px;"></div>

<!-- Encabezado con título, subtítulo y logo -->
<div class="container-fluid px-4 py-4">
  <div class="d-flex justify-content-between align-items-center mb-3">

    <!-- Título y subtítulo -->
    <div>
      <h2 class="fw-bold text-primary">Dashboard de Flujo de Agua</h2>
      <p class="text-muted">Visualización interactiva de las mediciones de sensores</p>
    </div>

    <!-- Logo con botón en línea vertical -->
    <div class="d-flex flex-column align-items-end">
      <div class="d-flex align-items-center gap-3">
        <%= image_tag "LunaWater-nobg.png", alt: "Luna Water", width: 200 %>
      </div>
    </div>



  </div>
  <!-- Filtros -->
  <div class="row g-3 align-items-center mb-4">
    <div class="col-auto">
      <%= date_field_tag :start_date, Date.today, class: "form-control" %>
    </div>
    <div class="col-auto">
      <%= date_field_tag :end_date, Date.today, class: "form-control" %>
    </div>
    <div class="col-auto">
      <%= select_tag :sensor, options_for_select(["Todos los sensores", "Sensor A"]), class: "form-select" %>
    </div>

    <!-- Botones de acción más abajo -->
    <div class="col-auto d-flex align-items-center gap-2" style="margin-top: 15px;">
      <%= button_to "Actualizar", dashboard_index_path, method: :get, class: "btn btn-outline-primary" %>
      <%= link_to "Exportar", "#", class: "btn btn-outline-secondary" %>
      <%= button_to "Cerrar sesión", logout_path, method: :delete, class: "btn btn-outline-danger", style: "margin-left: 587px;", data: { turbo: false } %>
    </div>
  </div>

  <!-- Resumen de métricas -->
  <div class="row text-center mb-5">
    <%# Volumen Total %>
    <div class="col-md-3">
      <div class="card border-primary shadow-sm h-100">
        <div class="card-body">
          <div class="d-flex align-items-center mb-3">
            <%= image_tag "waterdrop.png", width: 28, class: "me-3" %>
            <div class="text-start">
              <div class="fw-semibold fs-5">Volumen Total</div>
              <div class="fs-5 text-primary fw-bold">
                <%= number_with_precision(@volumen_total || 0.297, precision: 3) %> <small>m³</small>
              </div>
            </div>
          </div>
          <div class="progress" style="height: 6px;">
            <div class="progress-bar bg-info" style="width: 75%;"></div>
          </div>
        </div>
      </div>
    </div>

    <%# Flujo Promedio %>
    <div class="col-md-3">
      <div class="card border-info shadow-sm h-100">
        <div class="card-body">
          <div class="d-flex align-items-center mb-3">
            <%= image_tag "arrow.png", width: 28, class: "me-3" %>
            <div class="text-start">
              <div class="fw-semibold fs-5">Flujo Promedio</div>
              <div class="fs-5 text-info fw-bold">
                <%= number_with_precision(@flujo_promedio || 5.58, precision: 2) %> <small>L/min</small>
              </div>
            </div>
          </div>
          <div class="progress" style="height: 6px;">
            <div class="progress-bar bg-primary" style="width: 60%;"></div>
          </div>
        </div>
      </div>
    </div>

    <%# Duración Total %>
    <div class="col-md-3">
      <div class="card border-success shadow-sm h-100">
        <div class="card-body">
          <div class="d-flex align-items-center mb-3">
            <%= image_tag "clock.png", width: 28, class: "me-3" %>
            <div class="text-start">
              <div class="fw-semibold fs-5">Duración Total</div>
              <div class="fs-5 text-success fw-bold">
                <%= number_with_precision(@duracion_total || 60.0, precision: 2) %> <small>min</small>
              </div>
            </div>
          </div>
          <div class="progress" style="height: 6px;">
            <div class="progress-bar bg-success" style="width: 50%;"></div>
          </div>
        </div>
      </div>
    </div>

    <%# Total Garrafones %>
    <div class="col-md-3">
      <div class="card border-primary shadow-sm h-100">
        <div class="card-body">
          <div class="d-flex align-items-center mb-3">
            <%= image_tag "cyan.png", width: 28, class: "me-3" %>
            <div class="text-start">
              <div class="fw-semibold fs-5">Total Garrafones</div>
              <div class="fs-5 text-primary fw-bold">
                <%= number_with_precision(@total_garrafones || 15.62, precision: 2) %>
              </div>
            </div>
          </div>
          <div class="progress" style="height: 6px;">
            <div class="progress-bar bg-primary" style="width: 85%;"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Menú de pestañas para tablas -->
  <div class="container-fluid mb-5">
    <ul class="nav nav-tabs" id="dashboardTabs" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link active" id="flujo-tab" data-bs-toggle="tab" data-bs-target="#flujo" type="button" role="tab" aria-controls="flujo" aria-selected="true">Flujo de Agua</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="volumen-tab" data-bs-toggle="tab" data-bs-target="#volumen" type="button" role="tab" aria-controls="volumen" aria-selected="false">Volumen</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="distribucion-tab" data-bs-toggle="tab" data-bs-target="#distribucion" type="button" role="tab" aria-controls="distribucion" aria-selected="false">Distribución</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="datos-tab" data-bs-toggle="tab" data-bs-target="#datos" type="button" role="tab" aria-controls="datos" aria-selected="false">Datos</button>
      </li>
    </ul>

    <!-- Contenido de las pestañas -->
    <div class="tab-content border p-4" id="dashboardTabsContent">
      <div class="tab-pane fade show active" id="flujo" role="tabpanel" aria-labelledby="flujo-tab">
        <h5>Flujo de Agua</h5>
        <p>Contenido para la pestaña de flujo de agua.</p>
      </div>
      <div class="tab-pane fade" id="volumen" role="tabpanel" aria-labelledby="volumen-tab">
        <h5>Volumen</h5>
        <p>Contenido para la pestaña de volumen.</p>
      </div>
      <div class="tab-pane fade" id="distribucion" role="tabpanel" aria-labelledby="distribucion-tab">
        <h5>Distribución de Volumen por Medición</h5>
        <p>Distribución porcentual del volumen de agua por medición</p>

        <div class="d-flex flex-column align-items-center">
          <svg viewBox="0 0 36 36" width="300" height="300" style="overflow: visible;" id="volume-chart">
            <% total = @mediciones_datos.sum { |m| m[:volumen_m3] } %>
            <% offset = 0 %>
            <% @mediciones_datos.each do |medicion| %>
              <% porcentaje = (medicion[:volumen_m3] / total.to_f) * 100 %>
              <circle
                r="15.9"
                cx="18"
                cy="18"
                stroke="<%= medicion[:color] %>"
                stroke-width="3.2"
                stroke-dasharray="<%= porcentaje %> <%= 100 - porcentaje %>"
                stroke-dashoffset="<%= offset %>"
                fill="transparent"
                class="chart-segment"
                data-label="<%= medicion[:nombre_sensor] %> (<%= medicion[:volumen_m3] %> m³)"
                />
              <% offset -= porcentaje %>
            <% end %>

            <!-- Texto central con el volumen total -->
            <text x="50%" y="50%" text-anchor="middle" dominant-baseline="middle" font-size="0.3em" font-weight="bold" fill="#333">
              <%= @volumen_total %> m³
            </text>
          </svg>

          <!-- Tooltip -->
          <div id="chart-tooltip" class="chart-tooltip"></div>
        </div>
      </div>

      <!-- Tabla de mediciones -->
      <div class="tab-pane fade" id="datos" role="tabpanel" aria-labelledby="datos-tab">
        <h5>Datos de Mediciones</h5>
        <p>Tabla detallada de las mediciones de flujo de agua</p>
        <table class="table table-hover">
          <thead>
          <tr>
            <th>ID</th>
            <th>Sensor</th>
            <th>Inicio</th>
            <th>Fin</th>
            <th>Duración (min)</th>
            <th>Flujo (L/min)</th>
            <th>Volumen (m³)</th>
            <th>Garrafones</th>
            <th>Estado</th>
          </tr>
          </thead>
          <tbody>
          <% if @mediciones.present? %>
            <% @mediciones.each do |medicion| %>
              <tr>
                <td><%= medicion.id %></td>
                <td><%= medicion.sensor.nombre %></td>
                <td><%= medicion.timestamp_inicio.strftime("%d/%m/%Y %H:%M") %></td>
                <td><%= medicion.timestamp_fin.strftime("%d/%m/%Y %H:%M") %></td>
                <td><%= medicion.duracion_min %></td>
                <td><%= medicion.flujo_promedio %></td>
                <td><%= medicion.volumen_m3 %></td>
                <td><%= medicion.volumen_garrafones %></td>
                <td>
                  <% if medicion.flujo_promedio >= 5.0 %>
                    <span class="badge bg-success">Óptimo</span>
                  <% elsif medicion.flujo_promedio >= 2.0 %>
                    <span class="badge bg-warning">Normal</span>
                  <% else %>
                    <span class="badge bg-danger">Crítico</span>
                  <% end %>
                </td>
              </tr>
            <% end %>
          <% else %>
            <tr>
              <td colspan="9" class="text-center">No hay mediciones disponibles</td>
            </tr>
          <% end %>
          </tbody>
        </table>
      </div>
    </div>
  </div>



</div>
